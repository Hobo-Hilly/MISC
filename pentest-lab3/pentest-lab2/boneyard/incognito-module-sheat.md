

se the Incognito Module

Tokens in Windows are similar to the cookies in Web applications. Tokens can be of two types:

    Delegate: Are created when you log on to a system. These are also created when you connect to a system using Remote Desktop.
    Impersonate: Are created for a non-interactive session, such as connecting to a network drive.

Tokens only persist until you reboot the system. The delegate token is considered to impersonate token when the user logs off from the system. However, the impersonate token still holds all of the same rights as the delegate token.

With the Incognito module, you can track the valid tokens and impersonate them. You can then use these tokens for privilege escalation.

In this task, you will use the Incognito module. To do this, perform the following steps:
Step 1

Ensure that you are connected to PLABKALI01, and Meterpreter session is open.

Press Ctrl + l to clear the window. You should now see the meterpreter prompt.

Figure 1.43 Screenshot of PLABKALI01
Figure 1.43 Screenshot of PLABKALI01: Showing the metasploit window with the meterpreter prompt.

Step 2

First, you need to load the Incognito module in Meterpreter. Type the following command:

use incognito

Press Enter.

Figure 1.44 Screenshot of PLABKALI01
Figure 1.44 Screenshot of PLABKALI01: Entering the use incognito command.

Step 3

Notice the output. The incognito mode is loaded successfully. If you had loaded the incognito module in the session earlier, you would be prompted with the message that this module is already loaded.
Note: In your lab environment, it may not be loaded. The results are likely to vary.

Figure 1.45 Screenshot of PLABKALI01
Figure 1.45 Screenshot of PLABKALI01: Showing the output of the use incognito command.

Step 4

Next, you will need to list the valid tokens. Type the following command:

list_tokens -u

Press Enter.
Figure 1.46 Screenshot of PLABKALI01
Figure 1.46 Screenshot of PLABKALI01: Entering the list_tokens command to list the valid tokens.

Step 5

Notice the output of the list_tokens command. The token for PRACTICELABS\Administrator is also listed.

Figure 1.47 Screenshot of PLABKALI01
Figure 1.47 Screenshot of PLABKALI01: Showing the output of the list_tokens command.

Step 6

To be able to resume the privileges of PRACTICELABS\Administrator, you need to impersonate the token. To do this, type the following command:

impersonate_token PRACTICELABS\\Administrator

Press Enter.
Note: Ensure that you have a double backslash before Administrator. If you use only one backslash, you will be prompted with an error.

Figure 1.48 Screenshot of PLABKALI01
Figure 1.48 Screenshot of PLABKALI01: Entering the impersonate_token command to impersonate a token.

Step 7

Notice that you have been able to impersonate the PRACTICELABS\Administrator’s token successfully.

Figure 1.49 Screenshot of PLABKALI01
Figure 1.49 Screenshot of PLABKALI01: Showing the success of the impersonate_token command.

Step 8

You can verify that user ID.

To do this, type the following command:

getuid

Press Enter.

Figure 1.50 Screenshot of PLABKALI01
Figure 1.50 Screenshot of PLABKALI01: Entering the getuid command to get the user details.

Step 9

Note the output, which confirms that the session is now running with PRACTICELABS\Administrator privileges.

Figure 1.51 Screenshot of PLABKALI01
Figure 1.51 Screenshot of PLABKALI01: Showing the PRACTICELABS\Administrator user account as the output of the getuid command.

Step 10

Press Ctrl + l to clear the window.

With the impersonated token, you can invoke the Windows command shell. Type the following command:

execute -f cmd.exe -i -t

Press Enter.
Note: Using the -f parameter, you need to specify the file to be executed. The -i parameter is used for interacting with the victim’s system. The -t parameter uses the same role that has been impersonated.

Figure 1.52 Screenshot of PLABKALI01
Figure 1.52 Screenshot of PLABKALI01: Entering the execute command to open the command prompt.

Step 11

Notice that the Windows command shell is displayed. Type the following command to see the current user:

whoami

Press Enter.

Figure 1.53 Screenshot of PLABKALI01
Figure 1.53 Screenshot of PLABKALI01: Showing the output of the execute the command and entering the whoami command.

Step 12

Notice that the output displays practicelabs\administrator as the current user.

Figure 1.54 Screenshot of PLABKALI01
Figure 1.54 Screenshot of PLABKALI01: Showing the output of the whoami command.

Step 13

Type the following command to exit from the Windows command shell:

exit

Press Enter.

Figure 1.55 Screenshot of PLABKALI01
Figure 1.55 Screenshot of PLABKALI01: Entering the exit command to exit from the Windows shell.

Step 14

You are now back on the Meterpreter prompt.

Figure 1.56 Screenshot of PLABKALI01
Figure 1.56 Screenshot of PLABKALI01: Showing the meterpreter prompt.

Step 15

You can get the original token and release the PRACTICELABS\Administrator’s token. Type the following command:

rev2self

Press Enter.

Figure 1.57 Screenshot of PLABKALI01
Figure 1.57 Screenshot of PLABKALI01: Entering the rev2self command on the meterpreter prompt.

Step 16

The rev2self command executes successfully. Now, check the current user ID. Type the following command:

getuid

Press Enter.

Figure 1.58 Screenshot of PLABKALI01
Figure 1.58 Screenshot of PLABKALI01: Entering the getuid command at the meterpreter prompt.

Step 17

Notice that the username has changed from PRACTICELABS\Administrator to NT AUTHORITY\SYSTEM.

Figure 1.59 Screenshot of PLABKALI01
Figure 1.59 Screenshot of PLABKALI01: Showing the output of the getuid command.

Exit from Meterpreter and close the terminal window.
