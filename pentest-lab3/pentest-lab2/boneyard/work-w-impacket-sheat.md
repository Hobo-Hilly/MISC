 WORKING with Impacket

Impacket is a set of Python scripts that can help you retrieve quite a bit of information from a system. It includes several readymade scripts, which are categorized as:

    Remote Code Execution: atexec.py, dcomexec.py, psexec.py, smbexec.py, and wmiexec.py
    SMB/MSRPC: getArch.py, ifmap.py, lookupsid.py, samrdump.py, services.py, netview.py, smbclient.py, opdump.py, rpcdump.py, and reg.py
    Kerberos: GetST.py, GetPac.py, GetUserSPNs.py, GetNPUsers.py, ticketer.py, and raiseChild.py
    Windows Secret: mimikatz.py
    Server Tools/MiTM Attacks: karmaSMB.py and smbserver.py
    Windows Management Instrumentation (WMI): wmipersist.py
    SAMBA: sambaPipe.py and sambaPipe.py
    MSSQL: mssqlclient.py
    File Formats: ntfs-read.py and registry-read.py
    Miscellaneous: mqtt_check.py, rdp_check.py, sniffer.py, ping.py, and ping6.py

In this task, you will learn to use several scripts in Impacket. To do this, perform the following steps:
Step 1

Ensure that you are connected to PLABKALI01, and the terminal window is open.

Clear the screen with the clear command.

At the prompt, list the files and directories using the following command:

ls -l

Press Enter.

Figure 1.82 Screenshot of PLABKALI01
Figure 1.82 Screenshot of PLABKALI01: Entering the ls -l command to list the files and directories in the current directory.

Step 2

Notice the directories are listed. You need to navigate to the impacket directory. Type the following command:

cd impacket

Press Enter
Figure 1.83 Screenshot of PLABKALI01
Figure 1.83 Screenshot of PLABKALI01: Showing the output of the ls -l command and entering the cd command to navigate to the Impacket directory.

Step 3

You have navigated to the impacket directory. Type the following command to list the contents of this directory:

ls -l

Press Enter.
Step 4

Notice that the files are listed. You need to initiate the installation of Impacket using the setup.py script. Type the following command:

python setup.py install

Press Enter.

Figure 1.85 Screenshot of PLABKALI01
Figure 1.85 Screenshot of PLABKALI01: Entering the command to run the setup.py and install impacket.

Step 5

The Impacket installation does not take much time. After the installation, you are now at the prompt.

Figure 1.86 Screenshot of PLABKALI01
Figure 1.86 Screenshot of PLABKALI01: Showing the Kali prompt after completing the Impacket installation.

Step 6

Clear the screen with the clear command.

Next, navigate inside the examples directory.

cd examples

Press Enter
Figure 1.87 Screenshot of PLABKALI01
Figure 1.87 Screenshot of PLABKALI01: Entering the cd command to navigate to the examples directory.

Step 7

Now, list the files in this directory. Type the following command:

ls -l

Press Enter
Figure 1.88 Screenshot of PLABKALI01
Figure 1.88 Screenshot of PLABKALI01: Entering the ls -l command to list the files and directories in the examples directory.

Step 8

The files in the examples directory are listed.

Figure 1.89 Screenshot of PLABKALI01
Figure 1.89 Screenshot of PLABKALI01: Showing the listing of files in the examples directory.

Step 9

Clear the screen with the clear command.

You will now perform Remote Code Execution using the atexec script, which will use the Windows Task Scheduler service. Type the following command:

./atexec.py practicelabs/Administrator:Passw0rd@192.168.0.5 systeminfo

Press Enter.

Figure 1.90 Screenshot of PLABKALI01
Figure 1.90 Screenshot of PLABKALI01: Entering the command to execute the atexec.py script.

Step 10

The process will take a while to complete.

Notice the output. Towards the end of the output, it lists out the updates that are installed.

Figure 1.91 Screenshot of PLABKALI01
Figure 1.91 Screenshot of PLABKALI01: Showing the output of the atexec.py script.

Step 11

Scroll up to start of the command. You have been able to able to extract virtually all the information possible from the system.

Figure 1.92 Screenshot of PLABKALI01
Figure 1.92 Screenshot of PLABKALI01: Showing the output of the atexec.py script.

Step 12

Clear the screen with the clear command.

Next, you will use the psexec.py script. This script will provide the details of the local users on the PLABWIN810 system.

./psexec.py practicelabs/Administrator:Passw0rd@192.168.0.5 net user

Press Enter.

Figure 1.93 Screenshot of PLABKALI01
Figure 1.93 Screenshot of PLABKALI01: Entering the command to execute the psexec.py script.

Step 13

Notice that in the output, the local users are listed.

Figure 1.94 Screenshot of PLABKALI01
Figure 1.94 Screenshot of PLABKALI01: Showing the output of the psexec.py script.

Step 14

Clear the screen with the clear command.

Now, you can also run a stealthy script with the name wmiexec.py. It runs with elevated privileges. Type the following command:

./wmiexec.py practicelabs/Administrator:Passw0rd@192.168.0.5 netstat

Press Enter.

Figure 1.95 Screenshot of PLABKALI01
Figure 1.95 Screenshot of PLABKALI01: Entering the command to execute the wmiexec.py script.

Step 15

A list of connections is now displayed as the output.

Figure 1.96 Screenshot of PLABKALI01
Figure 1.96 Screenshot of PLABKALI01: Showing the output of the wmiexec.py script.

Step 16

Clear the screen with the clear command.

Using the lookupsid.py script, you can list the Windows SIDs using the MSRPC Interface. Type the following command:

./lookupsid.py practicelabs/Administrator:Passw0rd@192.168.0.5

Press Enter.

Figure 1.97 Screenshot of PLABKALI01
Figure 1.97 Screenshot of PLABKALI01: Entering the command to execute the lookupsid.py script.

Step 17

The SIDs for the domain and local users are now listed.

Figure 1.98 Screenshot of PLABKALI01
Figure 1.98 Screenshot of PLABKALI01: Showing the output of the lookupsid.py script.

Step 18

Clear the screen with the clear command.

Using the samrdump.py script, you can communicate with the Security Account Manager (SAM) Remote Interface. With the help of this script, you can list the information, such as system user accounts and their password-related information. Type the following command:

./samrdump.py practicelabs/Administrator:Passw0rd@192.168.0.5

Press Enter.

Figure 1.99 Screenshot of PLABKALI01
Figure 1.99 Screenshot of PLABKALI01: Entering the command to execute the samrdump.py script.

Step 19

Notice that the output displays the user accounts and password related information.

Figure 1.100 Screenshot of PLABKALI01
Figure 1.100 Screenshot of PLABKALI01: Showing the output of the samrdump.py script.

Step 20

Clear the screen with the clear command.

Using the services.py script, you can manipulate the services running on the target system. Type the following command:

./services.py practicelabs/Administrator:Passw0rd@192.168.0.5 list

Press Enter.

Figure 1.101 Screenshot of PLABKALI01
Figure 1.101 Screenshot of PLABKALI01: Entering the command to execute the services.py script.

Step 21

All services on the target system are listed with their current state, such as Running or Stopped.

Figure 1.102 Screenshot of PLABKALI01
Figure 1.102 Screenshot of PLABKALI01: Showing the output of the services.py script.

Step 22

Clear the screen with the clear command.

You can also add, delete, rename, download, or upload files on a target system. To do this, type the following command:

./smbclient.py practicelabs/Administrator:Passw0rd@192.168.0.5

Press Enter.

Figure 1.103 Screenshot of PLABKALI01
Figure 1.103 Screenshot of PLABKALI01: Entering the command to execute the smbclient.py script.

Step 23

Notice that the # prompt is displayed. Type the following command:

shares

Press Enter.
Note: You can type help to get more information on the commands that can be used.

Figure 1.104 Screenshot of PLABKALI01
Figure 1.104 Screenshot of PLABKALI01: Entering the shares command at the # prompt.

Step 24

Notice that the output displays the administrative shares. There is no user shared folders.

Figure 1.105 Screenshot of PLABKALI01
Figure 1.105 Screenshot of PLABKALI01: Showing the output with the administrative shares.

Step 25

Type exit to exit from the # prompt. You are now back on the Kali prompt.

Figure 1.106 Screenshot of PLABKALI01
Figure 1.106 Screenshot of PLABKALI01: Entering the exit command to exit from # prompt.k
